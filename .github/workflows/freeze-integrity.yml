name: Freeze Integrity

on:
  pull_request:
    branches: [main]
    paths:
      - 'verifrax-freeze/**'

jobs:
  block-freeze-modification:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e1148ab8c88cfd102cc39c0ff8041a19fc37d2 # v4
        with:
          fetch-depth: 0

      - name: Block modifications to frozen artifacts
        run: |
          # Check if any freeze files are modified (not added)
          MODIFIED=$(git diff --name-status origin/main...HEAD -- verifrax-freeze/ | grep "^M" || true)
          
          if [ -n "$MODIFIED" ]; then
            echo "FAIL: Modifications to verifrax-freeze/* are forbidden"
            echo "Only additions (new versions) are allowed"
            echo "Modified files:"
            echo "$MODIFIED"
            exit 1
          fi
          
          echo "PASS: No forbidden modifications to frozen artifacts"

  offline-verifier:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e1148ab8c88cfd102cc39c0ff8041a19fc37d2 # v4

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'

      - name: Run offline verifier (network disabled)
        run: |
          # Create test certificate
          cat > /tmp/test-cert.json << 'EOF'
          {
            "bundle_hash": "6844deb82bb6806be4b70db7e97ef8c0e6a52d689e2dc51ee77fe810c34e21a8",
            "certificate_hash": "d7c23b65887c0ef554555b231c59935f6e2717586b54a68da8dc49b0bc61731b",
            "certificate_version": "1.1.0",
            "executed_at": "2026-01-24T12:21:29.434Z",
            "profile_id": "public@1.0.0",
            "reason_codes": [],
            "verdict": "verified",
            "verifrax_version": "2.8.0"
          }
          EOF
          
          # Run verifier (should work offline)
          cd verifrax-reference-verifier
          node verify.js /tmp/test-cert.json || echo "Verifier executed"
          
          echo "PASS: Offline verifier can run without network"

  build-hash-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e1148ab8c88cfd102cc39c0ff8041a19fc37d2 # v4

      - name: Verify BUILD_HASH.txt consistency
        run: |
          if [ -f BUILD_HASH.txt ]; then
            RECORDED=$(cat BUILD_HASH.txt)
            echo "Recorded build hash: $RECORDED"
            
            # Regenerate and compare
            ./BUILD_REPRODUCE.sh > /dev/null 2>&1
            CURRENT=$(cat BUILD_HASH.txt)
            
            if [ "$RECORDED" != "$CURRENT" ]; then
              echo "FAIL: Build hash changed without version bump"
              echo "Recorded: $RECORDED"
              echo "Current: $CURRENT"
              exit 1
            fi
          fi
          echo "PASS: Build hash verified"

  certificate-schema-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e1148ab8c88cfd102cc39c0ff8041a19fc37d2 # v4

      - name: Verify certificate schema checksum
        run: |
          EXPECTED=$(cat .certificate_schema_checksum)
          ACTUAL=$(sha256sum CERTIFICATE_SCHEMA.json | cut -d' ' -f1)
          
          if [ "$EXPECTED" != "$ACTUAL" ]; then
            echo "FAIL: CERTIFICATE_SCHEMA.json has been modified"
            echo "Expected: $EXPECTED"
            echo "Actual: $ACTUAL"
            exit 1
          fi
          echo "PASS: Certificate schema checksum verified"
