name: Conformance - Delivery v1 Determinism Gate

on:
  push:
    paths:
      - 'public/conformance/golden/delivery_v1/**'
      - 'core/engine/**'
      - 'verification/reference-verifier/**'
      - '.github/workflows/conformance-delivery-v1.yml'
  pull_request:
    paths:
      - 'public/conformance/golden/delivery_v1/**'
      - 'core/engine/**'
      - 'verification/reference-verifier/**'
      - '.github/workflows/conformance-delivery-v1.yml'

jobs:
  conformance-delivery-v1:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build verifier
        run: pnpm build || true
      
      - name: Run delivery CLI on golden bundle
        id: run-verifier
        run: |
          BUNDLE_PATH="public/conformance/golden/delivery_v1/input"
          OUTPUT_DIR="/tmp/delivery-output"
          
          # Run delivery command
          node engines/cinelint/apps/cli/bin/verifrax.js delivery run \
            --in "$BUNDLE_PATH" \
            --out "$OUTPUT_DIR" \
            --profile delivery_v1@1.0.0 || {
            # Fallback: use reference verifier directly
            node -e "
              const { verifyBundle } = require('./verification/reference-verifier/index.ts');
              const result = verifyBundle({ bundlePath: '$BUNDLE_PATH', profileId: 'delivery_v1@1.0.0' });
              require('fs').writeFileSync('$OUTPUT_DIR/verdict.json', JSON.stringify(result, null, 2));
            " || {
              echo "⚠️  Could not run verifier, checking expected output"
            }
          }
      
      - name: Verify bundle hash matches expected
        run: |
          OUTPUT_DIR="/tmp/delivery-output"
          EXPECTED_DIR="public/conformance/golden/delivery_v1/expected"
          
          if [ ! -f "$OUTPUT_DIR/verdict.json" ]; then
            echo "❌ Verdict output not found"
            exit 1
          fi
          
          # Extract bundle_hash from output
          BUNDLE_HASH=$(jq -r '.bundle_hash' "$OUTPUT_DIR/verdict.json")
          
          if [ -z "$BUNDLE_HASH" ] || [ "$BUNDLE_HASH" = "null" ]; then
            echo "❌ bundle_hash missing from verdict output"
            exit 1
          fi
          
          # Check expected bundle_hash if it exists
          if [ -f "$EXPECTED_DIR/bundle_hash.txt" ]; then
            EXPECTED_HASH=$(cat "$EXPECTED_DIR/bundle_hash.txt" | tr -d '\n')
            if [ "$BUNDLE_HASH" != "$EXPECTED_HASH" ]; then
              echo "❌ Bundle hash mismatch"
              echo "Expected: $EXPECTED_HASH"
              echo "Got: $BUNDLE_HASH"
              exit 1
            fi
            echo "✅ Bundle hash matches expected: $BUNDLE_HASH"
          else
            echo "⚠️  No expected bundle_hash.txt found, saving current hash"
            mkdir -p "$EXPECTED_DIR"
            echo "$BUNDLE_HASH" > "$EXPECTED_DIR/bundle_hash.txt"
          fi
      
      - name: Verify verdict_id format
        run: |
          OUTPUT_DIR="/tmp/delivery-output"
          VERDICT_ID=$(jq -r '.verdict_id' "$OUTPUT_DIR/verdict.json")
          
          if [[ ! "$VERDICT_ID" =~ ^VFXV1:sha256:[a-f0-9]{64}:sha256:[a-f0-9]{64}$ ]]; then
            echo "❌ Invalid verdict_id format: $VERDICT_ID"
            echo "Expected format: VFXV1:sha256:<64-hex>:sha256:<64-hex>"
            exit 1
          fi
          
          echo "✅ Verdict ID format valid: $VERDICT_ID"
      
      - name: Verify binary-only output
        run: |
          OUTPUT_DIR="/tmp/delivery-output"
          KEYS=$(jq -r 'keys | sort | join(",")' "$OUTPUT_DIR/verdict.json")
          
          if [ "$KEYS" != "bundle_hash,verdict_id" ]; then
            echo "❌ Output contains extra keys: $KEYS"
            echo "Expected only: bundle_hash,verdict_id"
            exit 1
          fi
          
          echo "✅ Binary-only output verified"
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

