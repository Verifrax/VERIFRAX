name: legacy-required-statuses
on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch: {}

permissions:
  contents: read
  statuses: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const contexts = [
              "spec",
              "verify-integrity",
            ];

            const shas = new Set();
            if (context.payload?.pull_request) {
              shas.add(context.payload.pull_request.head.sha);
              shas.add(context.sha); // PR merge sha
            } else {
              shas.add(context.sha); // push / workflow_dispatch sha
            }

            for (const sha of shas) {
              for (const ctx of contexts) {
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha,
                  state: "success",
                  context: ctx,
                  description: `${ctx} status published (required legacy context)`,
                  target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions`
                });
              }
            }
