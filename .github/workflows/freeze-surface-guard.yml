name: Freeze Surface Guard

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  freeze-surface-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: Enforce canonical freeze surface
        shell: bash
        run: |
          set -euo pipefail

          MANIFEST="freeze/FREEZE_SURFACE_MANIFEST.json"

          if [[ ! -f "$MANIFEST" ]]; then
            echo "::error::Missing $MANIFEST"
            exit 1
          fi

          # Base/head SHAs for PR vs push
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE_SHA="$(jq -r .pull_request.base.sha "$GITHUB_EVENT_PATH")"
            HEAD_SHA="$(jq -r .pull_request.head.sha "$GITHUB_EVENT_PATH")"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"

          # Build allowed set from manifest (root-relative), plus the manifest itself.
          mapfile -t ALLOWED < <(jq -r '.hash_bound_files[]?, .hash_files[]?' "$MANIFEST" | sort -u)
          ALLOWED+=("$MANIFEST")

          # Collect changed files (ignore freeze-archive entirely)
          mapfile -t CHANGED < <(git diff --name-only "$BASE_SHA" "$HEAD_SHA" \
            | grep -E '^freeze/' || true)

          mapfile -t CHANGED_CANON < <(printf "%s\n" "${CHANGED[@]}" \
            | grep -vE '^freeze-archive/' || true)

          echo "Changed under freeze/:"
          printf "%s\n" "${CHANGED_CANON[@]:-}" | sed 's/^/  - /' || true

          # Fail if any canonical-freeze path changes outside manifest allowlist.
          BAD=()
          for f in "${CHANGED_CANON[@]:-}"; do
            OK=0
            for a in "${ALLOWED[@]}"; do
              [[ "$f" == "$a" ]] && OK=1 && break
            done
            [[ $OK -eq 1 ]] || BAD+=("$f")
          done

          if [[ ${#BAD[@]} -gt 0 ]]; then
            echo "::error::Non-canonical modifications under freeze/ (not listed in $MANIFEST):"
            printf "%s\n" "${BAD[@]}" | sed 's/^/  - /'
            exit 1
          fi

          # Sanity: every manifest-listed file must exist in repo tree.
          MISSING=()
          for a in "${ALLOWED[@]}"; do
            [[ -f "$a" ]] || MISSING+=("$a")
          done

          if [[ ${#MISSING[@]} -gt 0 ]]; then
            echo "::error::Manifest lists files that do not exist:"
            printf "%s\n" "${MISSING[@]}" | sed 's/^/  - /'
            exit 1
          fi

          echo "OK: canonical freeze surface enforced"
