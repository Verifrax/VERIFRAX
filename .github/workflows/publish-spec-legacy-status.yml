name: Publish required legacy status: spec
on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  statuses: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Publish legacy status "spec" = success (head+merge)
        uses: actions/github-script@v7
        with:
          script: |
            const shas = new Set();

            // PR: publish to both head sha + merge sha (github.sha)
            if (context.payload && context.payload.pull_request) {
              shas.add(context.payload.pull_request.head.sha);
              shas.add(context.sha);
            } else {
              // push/workflow_dispatch: just publish to github.sha
              shas.add(context.sha);
            }

            for (const sha of shas) {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha,
                state: "success",
                context: "spec",
                description: "Legacy required status published explicitly"
              });
              core.info(`published spec=success on ${sha}`);
            }
