# .github/workflows/truth-index-integrity.yml
name: Truth Index Integrity

on:
  push:
    branches: [main]
  pull_request:

env:
  LC_ALL: C
  TZ: UTC

jobs:
  verify-integrity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: EX-001 gate (PR-only; governance/non-artifact = non-blocking)
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail

          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          # Ensure both SHAs exist locally for diff. No --prune to avoid touching refs checkout post-step may use.
          git fetch --no-tags --depth=1 origin "$BASE" "$HEAD" || true

          CHANGED="$(git diff --name-only "$BASE" "$HEAD" || true)"

          # Only run if index-related surface changed.
          INDEX_REGEX='^(index/|ci/verify-truth-index\.mjs$|\.github/workflows/truth-index-integrity\.yml$)'

          if ! echo "$CHANGED" | grep -E "$INDEX_REGEX" >/dev/null; then
            echo "EX-001: Governance-only PR (no index surface). Marking Truth Index Integrity non-blocking."
            exit 0
          fi

          # Index changed but repo doesn't have required baseline index file yet -> bootstrap non-blocking.
          if [ ! -f index/truth.ndjson ]; then
            echo "EX-001: Index surface changed but index/truth.ndjson missing. Non-blocking."
            exit 0
          fi

          # CI script missing -> bootstrap non-blocking (pre-freeze import).
          if [ ! -f ci/verify-truth-index.mjs ]; then
            echo "EX-001: ci/verify-truth-index.mjs missing. Non-blocking."
            exit 0
          fi

          echo "Index surface changed and artifacts present — continuing."

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: 20

      - name: Verify truth index integrity
        run: node ci/verify-truth-index.mjs

      - name: Verify index file exists
        run: |
          test -f index/truth.ndjson
          echo "✓ Index file present"

      - name: Verify SHA256SUMS
        run: |
          cd index
          if [ -f SHA256SUMS.txt ]; then
            shasum -a 256 -c SHA256SUMS.txt
            echo "✓ SHA256SUMS verified"
          else
            echo "⚠ SHA256SUMS.txt not found (bootstrap)"
          fi
          cd "$GITHUB_WORKSPACE"

      - name: Verify genesis hash anchor
        run: |
          cd index
          if [ -f GENESIS_HASH.txt ]; then
            echo "✓ GENESIS_HASH.txt present"
            cat GENESIS_HASH.txt
          else
            echo "⚠ GENESIS_HASH.txt not found (bootstrap)"
          fi
          cd "$GITHUB_WORKSPACE"

      # Leave workspace and .git intact so actions/checkout post-step can run (avoids git exit 128).
      - name: Verify workspace intact for checkout post-step
        if: always()
        run: |
          cd "$GITHUB_WORKSPACE"
          test -d .git || { echo "FATAL: .git missing"; exit 1; }
          git status >/dev/null || { echo "FATAL: git status failed"; exit 1; }
          echo "Workspace and .git intact."
