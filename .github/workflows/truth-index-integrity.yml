name: Truth Index Integrity

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  verify-integrity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve refs safely
        run: |
          set -euo pipefail

          git remote set-url origin "https://github.com/${{ github.repository }}.git"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.base_ref }}"
            PR="${{ github.event.pull_request.number }}"

            git fetch --no-tags --prune origin \
              "+refs/heads/${BASE}:refs/remotes/origin/base" \
              "+refs/pull/${PR}/head:refs/remotes/origin/pr"

            MB="$(git merge-base refs/remotes/origin/base refs/remotes/origin/pr)"
            CHANGED="$(git diff --name-only "$MB" refs/remotes/origin/pr)"
          else
            BRANCH="${{ github.ref_name }}"
            git fetch --no-tags --prune origin \
              "+refs/heads/${BRANCH}:refs/remotes/origin/base"

            CHANGED="$(git diff --name-only HEAD~1 HEAD)"
          fi

          echo "Changed files:"
          echo "$CHANGED"

          # keep existing integrity logic here
