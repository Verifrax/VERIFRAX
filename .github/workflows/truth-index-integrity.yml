# .github/workflows/truth-index-integrity.yml
name: Truth Index Integrity

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  LC_ALL: C
  TZ: UTC

jobs:
  verify-integrity:
    runs-on: ubuntu-latest
    env:
      RUN_TRUTH_INDEX: 'true'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Default PR mode = non-blocking until proven
        if: github.event_name == 'pull_request'
        run: echo "RUN_TRUTH_INDEX=false" >> "$GITHUB_ENV"

      - name: EX-001 gate (PR-only; governance/non-artifact = non-blocking)
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail

          # Fetch by refs so diff is deterministic. Head may be from fork (not in origin).
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git fetch --no-tags origin "+refs/heads/$BASE_REF:refs/remotes/origin/base"

          HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          HEAD_REF=""
          git fetch --no-tags --depth=1 "https://github.com/$HEAD_REPO.git" \
            "+refs/heads/$HEAD_REF:refs/remotes/origin/head" || \
          git fetch --no-tags --depth=1 origin "+refs/heads/$HEAD_REF:refs/remotes/origin/head"

          # Diff from merge-base so "what the PR introduces" is independent of branch history.
          MB="$(git merge-base refs/remotes/origin/base refs/remotes/origin/head 2>/dev/null || true)"
          if [ -z "$MB" ]; then
            echo "EX-001: merge-base unavailable; defaulting to run verifier (conservative)."
            echo "RUN_TRUTH_INDEX=true" >> "$GITHUB_ENV"
            exit 0
          fi
          CHANGED="$(git diff --name-only "$MB" refs/remotes/origin/head)"

          echo "EX-001 changed files:"
          echo "$CHANGED"

          # Only run if index-related surface changed.
          INDEX_REGEX='^(index/|ci/verify-truth-index\.mjs$|\.github/workflows/truth-index-integrity\.yml$)'

          if ! echo "$CHANGED" | grep -E "$INDEX_REGEX" >/dev/null; then
            echo "EX-001: Governance-only PR (no index surface). Non-blocking."
            echo "RUN_TRUTH_INDEX=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # Index changed but repo doesn't have required baseline index file yet -> bootstrap non-blocking.
          if [ ! -f index/truth.ndjson ]; then
            echo "EX-001: Index surface changed but index/truth.ndjson missing. Non-blocking."
            echo "RUN_TRUTH_INDEX=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # CI script missing -> bootstrap non-blocking (pre-freeze import).
          if [ ! -f ci/verify-truth-index.mjs ]; then
            echo "EX-001: ci/verify-truth-index.mjs missing. Non-blocking."
            echo "RUN_TRUTH_INDEX=false" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "RUN_TRUTH_INDEX=true" >> "$GITHUB_ENV"
          echo "Index surface changed and artifacts present — continuing."

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        if: env.RUN_TRUTH_INDEX == 'true'
        with:
          node-version: 20

      - name: Precheck git health (before node)
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          test -d .git
          git status >/dev/null
          git rev-parse --is-inside-work-tree
          echo "Precheck OK"

      # Run in $RUNNER_TEMP so script cannot mutate workspace/.git. Previous = base (PR) or parent (push).
      - name: Verify truth index integrity (isolated)
        if: env.RUN_TRUTH_INDEX == 'true'
        shell: bash
        run: |
          set -euo pipefail
          PREV="$RUNNER_TEMP/previous-truth.ndjson"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            if ! git show "$BASE_SHA":index/truth.ndjson > "$PREV" 2>/tmp/gitshow.err; then
              echo "Bootstrap/skip: cannot read base index (maybe absent)."
              cat /tmp/gitshow.err || true
              : > "$PREV"
            fi
          else
            if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
              git show HEAD^:index/truth.ndjson > "$PREV" 2>/dev/null || true
            else
              echo "Bootstrap: no parent commit found"
              : > "$PREV"
            fi
          fi

          WORK="$RUNNER_TEMP/truth-index-check"
          rm -rf "$WORK"
          mkdir -p "$WORK"
          cp -R index ci "$WORK/"
          cd "$WORK"
          PREVIOUS_INDEX_PATH="$PREV" node ci/verify-truth-index.mjs

      - name: Postcheck git health (after node)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          test -d .git || { echo "FATAL: .git missing AFTER node"; exit 1; }
          git status >/dev/null || { echo "FATAL: git status failed AFTER node"; exit 1; }
          echo "Postcheck OK"

      - name: Verify index file exists
        if: env.RUN_TRUTH_INDEX == 'true'
        run: |
          test -f index/truth.ndjson
          echo "✓ Index file present"

      - name: Verify SHA256SUMS
        if: env.RUN_TRUTH_INDEX == 'true'
        run: |
          cd index
          if [ -f SHA256SUMS.txt ]; then
            shasum -a 256 -c SHA256SUMS.txt
            echo "✓ SHA256SUMS verified"
          else
            echo "⚠ SHA256SUMS.txt not found (bootstrap)"
          fi
          cd "$GITHUB_WORKSPACE"

      - name: Verify genesis hash anchor
        if: env.RUN_TRUTH_INDEX == 'true'
        run: |
          cd index
          if [ -f GENESIS_HASH.txt ]; then
            echo "✓ GENESIS_HASH.txt present"
            cat GENESIS_HASH.txt
          else
            echo "⚠ GENESIS_HASH.txt not found (bootstrap)"
          fi
          cd "$GITHUB_WORKSPACE"
