name: Truth Index Integrity

on: [push, pull_request]

jobs:
  verify-integrity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for comparison
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Verify truth index integrity
        run: node ci/verify-truth-index.mjs
      
      - name: Verify index file exists
        run: |
          test -f index/truth.ndjson || exit 1
          echo "✓ Index file present"
      
      - name: Verify SHA256SUMS
        run: |
          cd index
          if [ -f SHA256SUMS.txt ]; then
            shasum -a 256 -c SHA256SUMS.txt || exit 1
            echo "✓ SHA256SUMS verified"
          else
            echo "⚠ SHA256SUMS.txt not found (first commit)"
          fi
      
      - name: Verify genesis hash anchor
        run: |
          if [ -f index/GENESIS_HASH.txt ]; then
            echo "✓ GENESIS_HASH.txt present"
            cat index/GENESIS_HASH.txt
          else
            echo "⚠ GENESIS_HASH.txt not found (pre-v2.3.0)"
          fi

