name: release-tag
on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to create (e.g. v1.0.2 or v1)"
        required: true
        type: string
      title:
        description: "Release title"
        required: true
        type: string
      notes:
        description: "Release notes"
        required: true
        type: string
      target:
        description: "Git ref to tag (default: HEAD). Use e.g. v1.0.2^{} for alias tags."
        required: false
        type: string
        default: ""

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create / move tag
        run: |
          TAG="${{ inputs.tag }}"
          TARGET="${{ inputs.target }}"
          [ -n "$TARGET" ] || TARGET="HEAD"

          git config user.name  "verifrax-release-bot"
          git config user.email "verifrax-release-bot@users.noreply.github.com"

          git tag -fa "$TAG" "$TARGET" -m "${{ inputs.title }}"
          git push --force origin "$TAG"

      - name: Create / update release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete "${{ inputs.tag }}" --repo "${{ github.repository }}" -y || true
          gh release create "${{ inputs.tag }}" \
            --repo  "${{ github.repository }}" \
            --title "${{ inputs.title }}" \
            --notes "${{ inputs.notes }}"
